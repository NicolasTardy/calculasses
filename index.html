<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Projection de Revenus d'Assurance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        .card {
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
        }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        /* Style pour rendre le nom du produit sticky et z-index plus haut */
        .sticky-col {
            position: sticky;
            left: 0;
            z-index: 20;
            background-color: white; /* Assure que le fond reste blanc lors du défilement */
        }
        /* Style pour les en-têtes de tableau (multiples niveaux) */
        .sticky-header {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        /* Assure que l'en-tête de la table de détail colle aussi */
        .sticky-header-detail table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        /* Assure que la première colonne de la table de détail colle */
        .sticky-col-detail {
            position: sticky;
            left: 0;
            z-index: 20;
            background-color: #f9fafb; /* bg-gray-50 */
            border-right: 1px solid #e5e7eb; /* border-gray-200 */
        }
        /* Applique un fond aux cellules de la colonne sticky pour qu'elles masquent le contenu */
        .sticky-col-detail.bg-blue-50 { background-color: #EFF6FF; }
        .sticky-col-detail.bg-purple-50 { background-color: #FAF5FF; }
        .sticky-col-detail.bg-red-50 { background-color: #FEF2F2; }
        .sticky-col-detail.bg-blue-100 { background-color: #DBEAFE; }
        .sticky-col-detail.bg-green-100 { background-color: #D1FAE5; }
        .sticky-col-detail.bg-green-50 { background-color: #ECFDF5; }
        
        .cf-total-cell {
            min-width: 60px; /* Assure une largeur minimale pour les cellules mensuelles */
        }
        /* Classe pour aligner les métriques de résultats */
        .result-metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.25rem 0;
        }
        .result-label {
            font-weight: 500;
        }
        .result-value {
            font-weight: 700;
            text-align: right;
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <h1 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
            <svg class="w-8 h-8 mr-3 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
            Projection de Rentabilité des Offres d'Assurance
        </h1>
        <p class="text-gray-600 mb-8">
            Ajustez les variables pour comparer la rentabilité nette de l'Offre 1 (AS) et de l'Offre 2 (AP). 
            <span class="font-bold text-red-600">Le calcul est basé sur 4 ans (48 mois de ventes continues).</span>
        </p>

        <!-- Configuration Globale -->
        <h2 class="text-2xl font-semibold text-gray-800 mb-4 pt-4 border-t border-gray-300">Variables Globales</h2>
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            
            <!-- Taux d'Actualisation -->
            <div class="bg-yellow-50 p-4 card col-span-1 border border-yellow-300">
                <label for="discountRate" class="block text-sm font-medium text-gray-700">Taux d'Actualisation Annuel (%)</label>
                <input type="number" id="discountRate" value="5" step="0.1" min="0" class="mt-1 block w-full rounded-lg border-yellow-300 shadow-sm p-2 text-lg font-semibold border focus:ring-yellow-500 focus:border-yellow-500" oninput="calculate()">
            </div>
            
            <!-- Profit Sharing Offre 1 -->
            <div class="bg-blue-50 p-4 card col-span-1 border border-blue-200">
                <label for="profitSharing" class="block text-sm font-medium text-blue-700">Profit Sharing Offre 1 (€/vente)</label>
                <input type="number" id="profitSharing" value="1" step="0.01" min="0" class="mt-1 block w-full rounded-lg border-blue-300 shadow-sm p-2 text-lg font-semibold border focus:ring-blue-500 focus:border-blue-500" oninput="calculate()">
            </div>

            <!-- Taux de pose de film Wefix (Mise à jour pour l'Offre 1) -->
            <div class="bg-blue-50 p-4 card col-span-1 border border-blue-200">
                <label for="wefixRate" class="block text-sm font-medium text-blue-700">Taux Pose Film Wefix (%) <span class="font-bold">(Offre 1 - iPhones)</span></label>
                <input type="number" id="wefixRate" value="70" step="1" min="0" max="100" class="mt-1 block w-full rounded-lg border-blue-300 shadow-sm p-2 text-lg font-semibold border focus:ring-blue-500 focus:border-blue-500" oninput="calculate()">
            </div>

            <!-- Montant perçu par pose Wefix (Mise à jour pour l'Offre 1) -->
            <div class="bg-blue-50 p-4 card col-span-1 border border-blue-200">
                <label for="wefixPrice" class="block text-sm font-medium text-blue-700">Montant Wefix (€/pose) <span class="font-bold">(Offre 1 - iPhones)</span></label>
                <input type="number" id="wefixPrice" value="13" step="0.01" min="0" class="mt-1 block w-full rounded-lg border-blue-300 shadow-sm p-2 text-lg font-semibold border focus:ring-blue-500 focus:border-blue-500" oninput="calculate()">
            </div>
        </div>
        
        <!-- Variables par Offre (Séparées) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <!-- Offre 1 Variables (AS) -->
            <div class="bg-blue-100/50 p-6 card border-2 border-blue-300">
                <h3 class="text-xl font-bold text-blue-800 mb-4">Offre 1 (AS) - Variables Clés</h3>
                <div class="space-y-4">
                    <div class="bg-white p-3 rounded-lg shadow-sm">
                        <label for="renunciationRate1" class="block text-sm font-medium text-gray-700">Taux de Renonciation (après 60 jours, %)</label>
                        <input type="number" id="renunciationRate1" value="15" min="0" max="100" class="mt-1 block w-full rounded-lg border-blue-300 shadow-sm p-2 font-semibold border focus:ring-blue-500 focus:border-blue-500" oninput="calculate()">
                    </div>
                    <div class="bg-white p-3 rounded-lg shadow-sm">
                        <label for="churnRate1" class="block text-sm font-medium text-gray-700">Taux de Churn (Mensuel %) <span class="font-bold">(dès M13)</span></label>
                        <input type="number" id="churnRate1" value="4" min="0" max="100" class="mt-1 block w-full rounded-lg border-blue-300 shadow-sm p-2 font-semibold border focus:ring-blue-500 focus:border-blue-500" oninput="calculate()">
                    </div>
                    <!-- NOUVEAU: Durée de vie Max -->
                    <div class="bg-white p-3 rounded-lg shadow-sm">
                        <label for="avgContractLife1" class="block text-sm font-medium text-gray-700">Durée de vie Max Contrat (mois)</label>
                        <input type="number" id="avgContractLife1" value="18" min="1" class="mt-1 block w-full rounded-lg border-blue-300 shadow-sm p-2 font-semibold border focus:ring-blue-500 focus:border-blue-500" oninput="calculate()">
                    </div>
                </div>
            </div>

            <!-- Offre 2 Variables (AP) -->
            <div class="bg-green-100/50 p-6 card border-2 border-green-300">
                <h3 class="text-xl font-bold text-green-800 mb-4">Offre 2 (AP) - Variables Clés</h3>
                <div class="space-y-4">
                    <div class="bg-white p-3 rounded-lg shadow-sm">
                        <label for="renunciationRate2" class="block text-sm font-medium text-gray-700">Taux de Renonciation (après 60 jours, %)</label>
                        <input type="number" id="renunciationRate2" value="10" min="0" max="100" class="mt-1 block w-full rounded-lg border-green-300 shadow-sm p-2 font-semibold border focus:ring-green-500 focus:border-green-500" oninput="calculate()">
                    </div>
                    <div class="bg-white p-3 rounded-lg shadow-sm">
                        <label for="churnRate2" class="block text-sm font-medium text-gray-700">Taux de Churn (Mensuel %) <span class="font-bold">(dès M13)</span></label>
                        <input type="number" id="churnRate2" value="2" min="0" max="100" class="mt-1 block w-full rounded-lg border-green-300 shadow-sm p-2 font-semibold border focus:ring-green-500 focus:border-green-500" oninput="calculate()">
                    </div>
                     <!-- NOUVEAU: Durée de vie Max -->
                    <div class="bg-white p-3 rounded-lg shadow-sm">
                        <label for="avgContractLife2" class="block text-sm font-medium text-gray-700">Durée de vie Max Contrat (mois)</label>
                        <input type="number" id="avgContractLife2" value="18" min="1" class="mt-1 block w-full rounded-lg border-green-300 shadow-sm p-2 font-semibold border focus:ring-green-500 focus:border-green-500" oninput="calculate()">
                    </div>
                </div>
            </div>
        </div>


        <!-- Tableau des Produits, Taux d'Attachement, Volumes et Marges -->
        <h2 class="text-2xl font-semibold text-gray-800 mb-4 pt-4 border-t border-gray-300">Configuration Détaillée par Famille de Produits</h2>
        <div class="bg-white card overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="sticky-header">
                    <!-- NIVEAU 1 : Séparation Offre 1 / Offre 2 -->
                    <tr>
                        <th rowspan="2" class="px-6 py-3 text-left text-xs font-medium text-gray-700 uppercase tracking-wider sticky-col bg-gray-100 border-b border-r border-gray-300">Famille de Produit</th>
                        <th rowspan="2" class="px-3 py-3 text-center text-xs font-medium text-gray-700 uppercase tracking-wider bg-gray-100 border-b border-gray-300">Volume de Base <span class="font-bold">(Mensuel)</span></th>
                        <th colspan="3" class="px-3 py-2 text-center text-sm font-bold bg-blue-100 text-blue-800 border-b border-blue-300">OFFRE 1 (AS)</th>
                        <th colspan="3" class="px-3 py-2 text-center text-sm font-bold bg-green-100 text-green-800 border-b border-green-300">OFFRE 2 (AP)</th>
                    </tr>
                    <!-- NIVEAU 2 : Détails des métriques -->
                    <tr class="bg-gray-50">
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider bg-blue-50 border-r border-blue-200">Prix/Mois (€)</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider bg-blue-50 border-r border-blue-200">Taux Marge (%)</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider bg-blue-50 border-r border-gray-200">Taux d'Attachement (%)</th>
                        
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider bg-green-50 border-r border-green-200">Prix/Mois (€)</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider bg-green-50 border-r border-green-200">Taux Marge (%)</th>
                        <th class="px-3 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider bg-green-50">Taux d'Attachement (%)</th>
                    </tr>
                </thead>
                <tbody id="productConfig" class="bg-white divide-y divide-gray-200">
                    <!-- Data rows injected by JS -->
                </tbody>
            </table>
        </div>

        <!-- Résultats de la Projection -->
        <h2 class="text-2xl font-semibold text-gray-800 mb-4 pt-8 border-t border-gray-300 mt-8">Résultats Consolides (Projection sur 4 Ans - Cumulatif)</h2>
        <p class="text-sm italic text-gray-600 mb-4">Les montants annuels sont cumulatifs depuis le début de la simulation (Mois 1).</p>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Offre 1 (AS) Results -->
            <div class="bg-blue-50 border-2 border-blue-400 p-6 card">
                <h3 class="text-xl font-bold text-blue-900 mb-4">Offre 1 (AS) - Détail Financier</h3>
                <div class="space-y-2 text-sm">
                    <p class="result-metric text-base text-gray-800"><span class="result-label">Total Ventes (48 mois):</span> <span id="totalSales1" class="result-value font-extrabold">0</span></p>
                    <p class="result-metric text-gray-700"><span class="result-label">Total Clients Effectifs (après Renonciation):</span> <span id="effectiveClients1" class="result-value font-medium">0</span></p>
                    <hr class="border-blue-200">
                    <p class="result-metric font-bold text-green-700 text-xl"><span class="result-label">Marge Totale Nette (Non Actualisée) :</span> <span id="totalMargin1" class="result-value font-extrabold text-xl">0,00 €</span></p>
                    
                    <!-- Détails de la Marge - Alignement ML-4 -->
                    <p class="result-metric text-yellow-700 italic ml-4"><span class="result-label">Marge Avancée (12 mois, totale):</span> <span id="upfrontMargin1" class="result-value font-medium">0,00 €</span></p>
                    <p class="result-metric text-yellow-700 italic ml-4"><span class="result-label">Air Time (Mois 13+, totale):</span> <span id="tailMargin1" class="result-value font-medium">0,00 €</span></p>
                    
                    <p class="result-metric font-bold text-purple-700 text-lg"><span class="result-label">Profit Sharing Total :</span> <span id="totalProfitSharing" class="result-value font-extrabold">0,00 €</span></p>
                    
                    <!-- Revenu Wefix -->
                    <p class="result-metric font-bold text-red-700 text-lg"><span class="result-label">Revenus Wefix Total :</span> <span id="totalWefixRevenue" class="result-value font-extrabold">0,00 €</span></p>
                    
                    <hr class="border-blue-400">
                    
                    <!-- LIGNE CLÉ : Encaissement Initial au moment de la vente -->
                    <p class="result-metric font-black text-red-600 text-xl border-t pt-2 border-dashed border-red-300">
                        <span class="result-label">Encaissement Initial M1 (Marge Avancée + P.S + Wefix) :</span> 
                        <span id="initialCashIn1" class="result-value font-black">0,00 €</span>
                    </p>

                    <p class="result-metric font-black text-blue-900 mt-4 text-2xl"><span class="result-label">Gain Total Net (Marge + P.S + Wefix):</span> <span id="totalNetGain1" class="result-value font-black">0,00 €</span></p>
                </div>
                
                <!-- Résultat Annuel Cumulatif Offre 1 -->
                <h4 class="text-lg font-bold text-gray-700 mt-6 mb-2 pt-2 border-t border-gray-300">Gains Cumulés (Non Actualisés)</h4>
                <div class="space-y-1 text-sm">
                    <p class="result-metric font-medium text-gray-800"><span class="result-label">Année 1 (M1-M12):</span> <span id="cumulGain1_1" class="result-value font-semibold text-base">0,00 €</span></p>
                    <p class="result-metric font-medium text-gray-800"><span class="result-label">Année 2 (M1-M24):</span> <span id="cumulGain1_2" class="result-value font-semibold text-base">0,00 €</span></p>
                    <p class="result-metric font-medium text-gray-800"><span class="result-label">Année 3 (M1-M36):</span> <span id="cumulGain1_3" class="result-value font-semibold text-base">0,00 €</span></p>
                    <p class="result-metric font-medium text-gray-800"><span class="result-label">Année 4 (M1-M48):</span> <span id="cumulGain1_4" class="result-value font-semibold text-base">0,00 €</span></p>
                </div>

                <!-- NOUVEAU: VAN Totale -->
                <hr class="border-blue-400 mt-4">
                <p class="result-metric font-black text-red-700 mt-2 text-2xl">
                    <span class="result-label">Valeur Actuelle Nette (VAN) :</span> 
                    <span id="totalNPV1" class="result-value font-black">0,00 €</span>
                </p>
            </div>

            <!-- Offre 2 (AP) Results -->
            <div class="bg-green-50 border-2 border-green-400 p-6 card">
                <h3 class="text-xl font-bold text-green-900 mb-4">Offre 2 (AP) - Détail Financier</h3>
                <div class="space-y-2 text-sm">
                    <p class="result-metric text-base text-gray-800"><span class="result-label">Total Ventes (48 mois):</span> <span id="totalSales2" class="result-value font-extrabold text-base">0</span></p>
                    <p class="result-metric text-gray-700"><span class="result-label">Total Clients Effectifs (après Renonciation):</span> <span id="effectiveClients2" class="result-value font-medium">0</span></p>
                    <hr class="border-green-300">
                    <p class="result-metric font-bold text-blue-700 text-xl"><span class="result-label">Marge Totale Nette (Non Actualisée) :</span> <span id="totalMargin2" class="result-value font-extrabold text-xl">0,00 €</span></p>
                    
                    <!-- Harmonisation de la mise en page (Placeholders) -->
                    <p class="result-metric text-sm italic ml-4 text-gray-500"><span class="result-label">Marge Avancée (12 mois, totale):</span> <span class="result-value font-medium text-gray-400">N/A (0,00 €)</span></p>
                    <p class="result-metric text-sm italic ml-4 text-gray-500"><span class="result-label">Air Time (Mois 13+, totale):</span> <span class="result-value font-medium text-gray-400">N/A (0,00 €)</span></p>
                    <p class="result-metric font-bold text-gray-500 text-lg"><span class="result-label">Profit Sharing Total :</span> <span class="result-value font-extrabold text-gray-400">N/A (0,00 €)</span></p>
                    <p class="result-metric font-bold text-gray-500 text-lg"><span class="result-label">Revenus Wefix Total :</span> <span class="result-value font-extrabold text-gray-400">N/A (0,00 €)</span></p>
                    
                    <hr class="border-green-400">

                    <!-- LIGNE CLÉ : Encaissement Initial au moment de la vente (Placeholder) -->
                    <p class="result-metric font-black text-gray-600 text-xl border-t pt-2 border-dashed border-gray-300">
                        <span class="result-label">Encaissement Initial M1 :</span> 
                        <span id="initialCashIn2" class="result-value font-black">0,00 €</span>
                    </p>

                    <p class="result-metric font-black text-green-900 mt-4 text-2xl"><span class="result-label">Gain Total Net (Marge seule):</span> <span id="totalNetGain2" class="result-value font-black">0,00 €</span></p>
                </div>

                <!-- Résultat Annuel Cumulatif Offre 2 -->
                <h4 class="text-lg font-bold text-gray-700 mt-6 mb-2 pt-2 border-t border-gray-300">Gains Cumulés (Non Actualisés)</h4>
                <div class="space-y-1 text-sm">
                    <p class="result-metric font-medium text-gray-800"><span class="result-label">Année 1 (M1-M12):</span> <span id="cumulGain2_1" class="result-value font-semibold text-base">0,00 €</span></p>
                    <p class="result-metric font-medium text-gray-800"><span class="result-label">Année 2 (M1-M24):</span> <span id="cumulGain2_2" class="result-value font-semibold text-base">0,00 €</span></p>
                    <p class="result-metric font-medium text-gray-800"><span class="result-label">Année 3 (M1-M36):</span> <span id="cumulGain2_3" class="result-value font-semibold text-base">0,00 €</span></p>
                    <p class="result-metric font-medium text-gray-800"><span class="result-label">Année 4 (M1-M48):</span> <span id="cumulGain2_4" class="result-value font-semibold text-base">0,00 €</span></p>
                </div>
                
                <!-- NOUVEAU: VAN Totale -->
                <hr class="border-green-400 mt-4">
                <p class="result-metric font-black text-red-700 mt-2 text-2xl">
                    <span class="result-label">Valeur Actuelle Nette (VAN) :</span> 
                    <span id="totalNPV2" class="result-value font-black">0,00 €</span>
                </p>
            </div>
        </div>

        <!-- Synthèse de Comparaison VAN -->
        <div id="comparisonSummary" class="mt-8 p-6 text-center card bg-gray-800 text-white border-2 border-red-500">
            <p class="text-xl font-bold">SYNTHÈSE DE RENTABILITÉ ACTUALISÉE (VAN)</p>
            <p id="vanWinnerMessage" class="text-3xl font-extrabold mt-2 text-yellow-300">Veuillez effectuer le calcul.</p>
            <p class="text-sm mt-1">Comparaison basée sur la Valeur Actuelle Nette de tous les flux de trésorerie accumulés sur l'horizon de 61 mois.</p>
        </div>
        
        <!-- NOUVEAU: Suivi du Parc Client -->
        <h2 class="text-2xl font-semibold text-gray-800 mb-4 pt-8 border-t border-gray-300 mt-8">Suivi du Parc Client Actif</h2>
        <p id="parkDescription" class="text-gray-600 mb-4">
            Simulation du nombre total de clients actifs chaque mois, en tenant compte des nouvelles ventes,
            de la renonciation (M3), du churn mensuel exponentiel (M13) et de la fin de vie.
        </p>
        <div id="clientParkDetail" class="bg-white card overflow-x-auto sticky-header-detail">
            <!-- Tableau du Parc Client inséré ici -->
        </div>

        <!-- NOUVEAU: Analyse Détaillée des Revenus -->
        <h2 class="text-2xl font-semibold text-gray-800 mb-4 pt-8 border-t border-gray-300 mt-8">Analyse Détaillée des Revenus (Non Actualisés)</h2>
        <p class="text-gray-600 mb-4">Affichage du chiffre d'affaires total (non margé) par mois pour toutes les familles de produits (hors P.S. et Wefix).</p>
        <div id="revenueDetail" class="bg-white card overflow-x-auto sticky-header-detail">
            <!-- Tableau des Revenus inséré ici -->
        </div>

        <!-- MODIFIÉ: Analyse Détaillée de la Marge Nette et des Flux -->
        <h2 class="text-2xl font-semibold text-gray-800 mb-4 pt-8 border-t border-gray-300 mt-8">Analyse Détaillée de la Marge Nette et des Flux (Cash Flow)</h2>
        <p class="text-gray-600 mb-4">Affichage des flux de trésorerie nets (Marge, P.S., Wefix) par mois (sur 61 mois).</p>
        <div id="cashFlowDetail" class="bg-white card overflow-x-auto sticky-header-detail">
            <!-- Tableaux de Cash Flow insérés ici -->
        </div>


    </div>

    <script>
        // --- CONSTANTES ET DONNÉES DE BASE ---
        const MAX_SALES_MONTHS = 48; // Période de vente (Années 1 à 4)
        const MAX_ANALYSIS_MONTHS = 61; // M1 à M61 (index 0 à 60)
        const M1_tail_rate = 0.10; // Marge 10% Offre 1 après 12 mois (fixe)

        // Définition initiale des produits et de leurs valeurs
        const products = [
            // L'index 0 est 'iPhones', utilisé pour le calcul Wefix
            { name: "iPhones", volume: 1000, price1: 19, margin1: 37, ta1: 25, price2: 12, margin2: 35, ta2: 30 },
            { name: "MacBook", volume: 1000, price1: 14, margin1: 37, ta1: 12, price2: 12, margin2: 35, ta2: 15 },
            { name: "AirPods", volume: 1000, price1: 8, margin1: 37, ta1: 9, price2: 6, margin2: 35, ta2: 15 },
            { name: "iPads", volume: 1000, price1: 12, margin1: 37, ta1: 12, price2: 10, margin2: 35, ta2: 15 },
            { name: "Apple Watch", volume: 1000, price1: 8, margin1: 37, ta1: 15, price2: 6, margin2: 35, ta2: 20 },
        ];


        // --- UTILS DE FORMATAGE ---

        function formatCurrency(value, decimals = 2) {
            if (isNaN(value) || value === null) return "0,00 €";
            return new Intl.NumberFormat('fr-FR', {
                style: 'currency',
                currency: 'EUR',
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(value);
        }

        function formatNumber(value, decimals = 0) {
            if (isNaN(value) || value === null) return "0";
            return new Intl.NumberFormat('fr-FR', {
                minimumFractionDigits: decimals,
                maximumFractionDigits: decimals
            }).format(value);
        }
        
        // --- LOGIQUE DE L'APPLICATION ---

        /**
         * Récupère toutes les variables et la configuration produit depuis les inputs du DOM.
         */
        function getInputs() {
            const inputs = {
                // Variables Globales
                renunciationRate1: (parseFloat(document.getElementById('renunciationRate1').value) || 0) / 100,
                renunciationRate2: (parseFloat(document.getElementById('renunciationRate2').value) || 0) / 100,
                // Le Churn Rate est maintenant un taux MENSUEL appliqué dès M13
                churnRate1: (parseFloat(document.getElementById('churnRate1').value) || 0) / 100,
                churnRate2: (parseFloat(document.getElementById('churnRate2').value) || 0) / 100,
                profitSharingUnit: parseFloat(document.getElementById('profitSharing').value) || 0,
                wefixRate: (parseFloat(document.getElementById('wefixRate').value) || 0) / 100,
                wefixPrice: parseFloat(document.getElementById('wefixPrice').value) || 0,
                annualRate: (parseFloat(document.getElementById('discountRate').value) || 0) / 100,
                monthlyRate: (parseFloat(document.getElementById('discountRate').value) || 0) / 100 / 12,
                
                // Durée de vie
                avgContractLife1: parseInt(document.getElementById('avgContractLife1').value) || 1,
                avgContractLife2: parseInt(document.getElementById('avgContractLife2').value) || 1,

                // Configuration Produit (mise à jour depuis les inputs)
                products: products.map((p, index) => ({
                    name: p.name,
                    volume: parseFloat(document.getElementById(`volume_${index}`).value) || 0,
                    price1: parseFloat(document.getElementById(`price1_${index}`).value) || 0,
                    margin1Rate: (parseFloat(document.getElementById(`margin1_${index}`).value) || 0) / 100,
                    ta1: (parseFloat(document.getElementById(`ta1_${index}`).value) || 0) / 100,
                    price2: parseFloat(document.getElementById(`price2_${index}`).value) || 0,
                    margin2Rate: (parseFloat(document.getElementById(`margin2_${index}`).value) || 0) / 100,
                    ta2: (parseFloat(document.getElementById(`ta2_${index}`).value) || 0) / 100,
                }))
            };
            return inputs;
        }

        /**
         * Calcule la Valeur Actuelle Nette (NPV) d'un flux de trésorerie.
         */
        function calculateNPV(cashFlows, monthlyDiscountRate) {
            let npv = 0;
            for (let t = 0; t < cashFlows.length; t++) {
                npv += cashFlows[t] / Math.pow(1 + monthlyDiscountRate, t);
            }
            return npv;
        }

        /**
         * Calcule les flux de trésorerie et les totaux consolidés pour les deux offres.
         */
        function performCalculations(data) {
            // Initialisation des totaux globaux (Non Actualisés)
            let totalSales1 = 0, totalSales2 = 0;
            let effectiveClients1 = 0, effectiveClients2 = 0;
            let totalMargin1 = 0, upfrontMargin1 = 0, tailMargin1 = 0;
            let totalMargin2 = 0;
            let totalProfitSharing = 0;
            let totalWefixRevenue = 0;

            // Initialisation des tableaux de Cash Flow et Revenus Totaux (sur 61 mois, index 0 = M1)
            let CF1_Margin_Only = new Array(MAX_ANALYSIS_MONTHS).fill(0);
            let CF_PS = new Array(MAX_ANALYSIS_MONTHS).fill(0);
            let CF_Wefix = new Array(MAX_ANALYSIS_MONTHS).fill(0);
            let CF2_Margin_Only = new Array(MAX_ANALYSIS_MONTHS).fill(0);
            
            let REV1_total = new Array(MAX_ANALYSIS_MONTHS).fill(0);
            let REV2_total = new Array(MAX_ANALYSIS_MONTHS).fill(0);

            // Arrays pour Parc Client
            let Park1_total = new Array(MAX_ANALYSIS_MONTHS).fill(0);
            let Park2_total = new Array(MAX_ANALYSIS_MONTHS).fill(0);
            
            // Les taux de churn sont maintenant mensuels
            const C1_monthly_rate = data.churnRate1;
            const C2_monthly_rate = data.churnRate2;

            data.products.forEach((p, index) => {
                const MAX_LIFE_1 = data.avgContractLife1;
                const MAX_LIFE_2 = data.avgContractLife2;

                // --- Calcul des Clients par cohorte mensuelle (k) ---
                const N1_cohort = p.volume * p.ta1; 
                const N_eff1_cohort = N1_cohort * (1 - data.renunciationRate1); 
                
                const N2_cohort = p.volume * p.ta2; 
                const N_eff2_cohort = N2_cohort * (1 - data.renunciationRate2); 
                
                const PS_cohort = N1_cohort * data.profitSharingUnit;

                // BOUCLE SUR LES 48 COHORTES (k = index de 0 à 47, soit M1 à M48 de vente)
                for (let k = 0; k < MAX_SALES_MONTHS; k++) {
                    
                    // Accumulation des totaux bruts
                    totalSales1 += N1_cohort;
                    totalSales2 += N2_cohort;
                    effectiveClients1 += N_eff1_cohort;
                    effectiveClients2 += N_eff2_cohort;
                    totalProfitSharing += PS_cohort;
                    
                    let wefixRevenue_cohort = 0; 
                    
                    if (index === 0) { // Uniquement pour iPhones
                        const N_wefix_effective = N_eff1_cohort * data.wefixRate;
                        wefixRevenue_cohort = N_wefix_effective * data.wefixPrice;
                        totalWefixRevenue += wefixRevenue_cohort;
                    }


                    // --- BOUCLE SUR LA VIE DE LA COHORTE (m) ---
                    // m = 0 est le Mois 1 d'abonnement
                    for (let m = 0; m < MAX_LIFE_1 || m < MAX_LIFE_2; m++) {
                        const t_analysis = k + m;
                        if (t_analysis >= MAX_ANALYSIS_MONTHS) break;
                        
                        // --- 1. POPULATION ACTIVE POUR LE MOIS M (P_active) ---
                        
                        // Offre 1
                        let P_active_1 = 0;
                        if (m < MAX_LIFE_1) {
                            if (m < 2) { 
                                P_active_1 = N1_cohort; // M1, M2 (brut, avant renonciation)
                            } else if (m < 12) { 
                                P_active_1 = N_eff1_cohort; // M3 à M12 (net renonciation)
                            } else { // M13 à MAX_LIFE_1-1 -> Churn Mensuel exponentiel
                                const exponent = m - 11; 
                                P_active_1 = N_eff1_cohort * Math.pow((1 - C1_monthly_rate), exponent);
                                // S'assurer que le parc n'est pas négatif (même si la durée max le coupe)
                                P_active_1 = Math.max(0, P_active_1);
                            }
                            Park1_total[t_analysis] += P_active_1;
                        }

                        // Offre 2
                        let P_active_2 = 0;
                        if (m < MAX_LIFE_2) {
                            if (m < 2) { 
                                P_active_2 = N2_cohort; // M1, M2 (brut, avant renonciation)
                            } else if (m < 12) { 
                                P_active_2 = N_eff2_cohort; // M3 à M12 (net renonciation)
                            } else { // M13 à MAX_LIFE_2-1 -> Churn Mensuel exponentiel
                                const exponent = m - 11;
                                P_active_2 = N_eff2_cohort * Math.pow((1 - C2_monthly_rate), exponent);
                                P_active_2 = Math.max(0, P_active_2);
                            }
                            Park2_total[t_analysis] += P_active_2;
                        }
                        
                        
                        // --- 2. CALCUL DES FLUX (MARGE / REVENU) ---
                        
                        // --- OFFRE 1 (AS) ---
                        if (m < MAX_LIFE_1) {
                            if (m === 0) { 
                                // M1: Marge Avancée (12 mois) + PS + Wefix
                                const M_upfront1_cohort = N_eff1_cohort * p.price1 * p.margin1Rate * 12;
                                const REV_upfront1_cohort = N1_cohort * p.price1 * 12; // Rev total
                                
                                CF1_Margin_Only[t_analysis] += M_upfront1_cohort;
                                CF_PS[t_analysis] += PS_cohort;
                                CF_Wefix[t_analysis] += wefixRevenue_cohort;
                                REV1_total[t_analysis] += REV_upfront1_cohort;
                                
                                totalMargin1 += M_upfront1_cohort;
                                upfrontMargin1 += M_upfront1_cohort;
                            } else if (m === 12 || m === 13) { 
                                // M13 et M14: Marge Queue (Air Time) - Utilise P_active_1 (Exponentiel)
                                if (P_active_1 > 0) {
                                    const M_tail1_monthly = P_active_1 * p.price1 * M1_tail_rate;
                                    const REV_tail1_monthly = P_active_1 * p.price1;

                                    CF1_Margin_Only[t_analysis] += M_tail1_monthly;
                                    REV1_total[t_analysis] += REV_tail1_monthly;
                                    totalMargin1 += M_tail1_monthly;
                                    tailMargin1 += M_tail1_monthly;
                                }
                            }
                            // Note: Les revenus des M2 à M12 (non 13/14) pour AS sont inclus dans Marge Avancée M1.
                        }
                        
                        // --- OFFRE 2 (AP) ---
                        if (m < MAX_LIFE_2) {
                            // Marge/Revenu Mensuel (basé sur P_active_2)
                            if (P_active_2 > 0) {
                                const cf_monthly = P_active_2 * p.price2 * p.margin2Rate;
                                const rev_monthly = P_active_2 * p.price2;

                                CF2_Margin_Only[t_analysis] += cf_monthly;
                                REV2_total[t_analysis] += rev_monthly;
                                totalMargin2 += cf_monthly;
                            }
                        }
                    }
                }
            });

            // --- Calculs finaux Globaux ---
            const CF1_Total_Combined = CF1_Margin_Only.map((v, i) => v + CF_PS[i] + CF_Wefix[i]);
            
            const totalNetGain1 = totalMargin1 + totalProfitSharing + totalWefixRevenue;
            const totalNetGain2 = totalMargin2;
            
            const totalNPV1 = calculateNPV(CF1_Total_Combined, data.monthlyRate);
            const totalNPV2 = calculateNPV(CF2_Margin_Only, data.monthlyRate);

            return {
                totalSales1, totalSales2, effectiveClients1, effectiveClients2,
                totalMargin1, upfrontMargin1, tailMargin1, totalMargin2,
                totalProfitSharing, totalWefixRevenue, totalNetGain1, totalNetGain2,
                totalNPV1, totalNPV2, 
                CF1_Margin_Only, CF_PS, CF_Wefix, CF1_Total_Combined, CF2_Margin_Only,
                REV1_total, REV2_total,
                Park1_total, Park2_total
            };
        }


        /**
         * Calcule les totaux cumulés (Gain Net et VAN) jusqu'à un mois donné (M1 à M_N).
         */
        function getCumulativeResults(cfArray, upToMonthIndex, monthlyRate) {
            let cumulativeNetGain = 0;
            let cumulativeNPV = 0;
            
            for (let t = 0; t <= upToMonthIndex; t++) {
                const cf = cfArray[t] || 0; 
                cumulativeNetGain += cf;
                cumulativeNPV += cf / Math.pow(1 + monthlyRate, t);
            }
            return { netGain: cumulativeNetGain, npv: cumulativeNPV };
        }

        /**
         * Calcule les totaux annuels (non actualisés) pour le Cash Flow Détaillé.
         */
        function calculateAnnualTotals(cfArray) {
            const annualTotals = {};
            for (let y = 1; y <= 4; y++) {
                let sum = 0;
                const startIdx = (y - 1) * 12; 
                const endIdx = startIdx + 11;
                
                for (let i = startIdx; i <= endIdx && i < MAX_SALES_MONTHS; i++) {
                    sum += cfArray[i] || 0;
                }
                annualTotals[`A${y}`] = sum;
            }
            return annualTotals;
        }

        /**
         * Génère le HTML pour une table de détail (CF, Revenu, ou Parc).
         * @param {string} title - Titre du tableau
         * @param {Array<object>} rowsData - { title, cf, bgColor, isCurrency }
         * @param {number} monthlyRate - Taux d'actualisation mensuel
         * @param {boolean} showNPV - Afficher ou non la colonne VAN
         */
        function generateDetailTable(title, rowsData, monthlyRate, showNPV) {
            
            // DÉFINITION DE L'UNITÉ
            const isCurrency = rowsData.length > 0 ? rowsData[0].isCurrency : true;
            const unit = isCurrency ? '€' : 'Nb';

            // En-têtes de mois M1...M61
            const monthHeaders = Array.from({ length: MAX_ANALYSIS_MONTHS }, (_, i) => {
                const month = i + 1;
                let className = '';
                if (month % 12 === 0) {
                    className = 'bg-gray-200 font-bold';
                }
                return `<th class="px-2 py-2 text-center text-xs font-medium text-gray-500 uppercase ${className} cf-total-cell">M${month}</th>`;
            }).join('');

            // Génération des lignes de données
            const tableRows = rowsData.map(row => {
                const { title, cf, bgColor, isCurrency } = row;
                
                const annualTotals = calculateAnnualTotals(cf);
                const npv = showNPV ? calculateNPV(cf, monthlyRate) : 0;
                const formatter = isCurrency ? (val, dec=0) => formatCurrency(val, dec) : (val, dec=0) => formatNumber(val, dec);

                // Cellules des 61 mois
                const cfCells = cf.map((val, i) => {
                    const month = i + 1;
                    let className = '';
                    if (month % 12 === 0) {
                        className = (bgColor.includes('blue') || bgColor.includes('purple') || bgColor.includes('red')) ? 'bg-blue-200' : 'bg-green-200';
                        if (bgColor.includes('font-bold')) className += ' font-bold';
                    }
                    return `<td class="px-2 py-2 text-sm text-gray-900 font-medium ${className} cf-total-cell">${formatter(val, 0)}</td>`;
                }).join('');
                
                // Cellules des 4 totaux annuels
                const annualCells = `<td class="px-2 py-2 text-sm text-gray-900 font-extrabold bg-gray-300 cf-total-cell">${formatter(annualTotals.A1, 0)}</td>` +
                                    `<td class="px-2 py-2 text-sm text-gray-900 font-extrabold bg-gray-300 cf-total-cell">${formatter(annualTotals.A2, 0)}</td>` +
                                    `<td class="px-2 py-2 text-sm text-gray-900 font-extrabold bg-gray-300 cf-total-cell">${formatter(annualTotals.A3, 0)}</td>` +
                                    `<td class="px-2 py-2 text-sm text-gray-900 font-extrabold bg-gray-300 border-r border-gray-400 cf-total-cell">${formatter(annualTotals.A4, 0)}</td>`;
                
                // Cellule NPV (si activée)
                const npvCell = showNPV ? `<td class="px-3 py-2 text-sm font-bold text-gray-900 bg-gray-100">${formatter(npv, 2)}</td>` : '';
                
                return `
                    <tr class="${bgColor}">
                        <td class="px-3 py-2 whitespace-nowrap text-sm font-semibold text-gray-900 sticky-col-detail ${bgColor}">${title}</td>
                        ${annualCells}
                        ${cfCells}
                        ${npvCell}
                    </tr>
                `;
            }).join('');

            // HTML de la table complète
            const npvHeader = showNPV ? `<th class="px-3 py-2 text-center text-xs font-bold text-gray-800 uppercase bg-gray-100">TOTAL VAN (M1-M61)</th>` : '';
            const npvSubHeader = showNPV ? `<th class="px-3 py-2 text-center text-xs font-bold text-gray-800 uppercase bg-gray-100 border-t border-gray-200">NPV</th>` : '';

            return `
                <div class="space-y-4 p-4">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <!-- Ligne 1: Titre Principal -->
                            <tr>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase sticky-col-detail">Détail (${unit})</th>
                                <th colspan="4" class="px-3 py-2 text-center text-xs font-bold text-gray-800 uppercase bg-gray-300 border-r border-gray-400">TOTAL ANNÉE (Non Actualisé)</th>
                                ${monthHeaders}
                                ${npvHeader}
                            </tr>
                            <!-- Ligne 2: Sous-Titres Annuels -->
                            <tr>
                                <th class="px-3 py-2 text-center text-xs font-medium text-gray-500 uppercase sticky-col-detail border-t border-gray-200"></th>
                                <th class="px-2 py-2 text-center text-xs font-bold text-gray-800 uppercase bg-gray-300">A1</th>
                                <th class="px-2 py-2 text-center text-xs font-bold text-gray-800 uppercase bg-gray-300">A2</th>
                                <th class="px-2 py-2 text-center text-xs font-bold text-gray-800 uppercase bg-gray-300">A3</th>
                                <th class="px-2 py-2 text-center text-xs font-bold text-gray-800 uppercase bg-gray-300 border-r border-gray-400">A4</th>
                                ${monthHeaders}
                                ${npvSubHeader}
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;
        }
        
        /**
         * Met à jour les 3 tables de détail (Parc, Revenu, CF)
         */
        function updateAllDetailTables(results, inputs) {
            
            // 1. Tableau du Parc Client
            const parkRows = [
                { title: "Parc Actif Offre 1 (AS)", cf: results.Park1_total, bgColor: "bg-blue-50", isCurrency: false },
                { title: "Parc Actif Offre 2 (AP)", cf: results.Park2_total, bgColor: "bg-green-50", isCurrency: false }
            ];
            document.getElementById('clientParkDetail').innerHTML = generateDetailTable(
                "Suivi du Parc Client Actif (Nombre de clients)", parkRows, inputs.monthlyRate, false
            );

            // 2. Tableau des Revenus
            const revenueRows = [
                { title: "Revenus Offre 1 (AS)", cf: results.REV1_total, bgColor: "bg-blue-50", isCurrency: true },
                { title: "Revenus Offre 2 (AP)", cf: results.REV2_total, bgColor: "bg-green-50", isCurrency: true }
            ];
            document.getElementById('revenueDetail').innerHTML = generateDetailTable(
                "Analyse des Revenus (Non Actualisés)", revenueRows, inputs.monthlyRate, false
            );

            // 3. Tableau des Cash Flow (Marge Nette)
            const cashFlowRows = [
                { title: "Marge Nette Offre 1 (AS)", cf: results.CF1_Margin_Only, bgColor: "bg-blue-50", isCurrency: true },
                { title: "Profit Sharing (AS)", cf: results.CF_PS, bgColor: "bg-purple-50", isCurrency: true },
                { title: "Revenus Wefix (AS)", cf: results.CF_Wefix, bgColor: "bg-red-50", isCurrency: true },
                { title: "CF Total Offre 1 (AS)", cf: results.CF1_Total_Combined, bgColor: "bg-blue-100 font-bold", isCurrency: true },
                { title: "CF Total Offre 2 (AP)", cf: results.CF2_Margin_Only, bgColor: "bg-green-100 font-bold", isCurrency: true }
            ];
            document.getElementById('cashFlowDetail').innerHTML = generateDetailTable(
                "Analyse de la Marge Nette et des Flux (Cash Flow)", cashFlowRows, inputs.monthlyRate, true
            );
        }


        /**
         * Met à jour tous les éléments d'affichage des résultats (Totaux et Cumulés).
         */
        function updateUI(results, inputs) {
            
            // Calcul des résultats cumulés par année
            // Utilisation de CF1_Total_Combined et CF2_Margin_Only comme Cash Flow Net
            const year1_1 = getCumulativeResults(results.CF1_Total_Combined, 11, inputs.monthlyRate);
            const year2_1 = getCumulativeResults(results.CF1_Total_Combined, 23, inputs.monthlyRate);
            const year3_1 = getCumulativeResults(results.CF1_Total_Combined, 35, inputs.monthlyRate);
            const year4_1 = getCumulativeResults(results.CF1_Total_Combined, 47, inputs.monthlyRate);
            
            const year1_2 = getCumulativeResults(results.CF2_Margin_Only, 11, inputs.monthlyRate);
            const year2_2 = getCumulativeResults(results.CF2_Margin_Only, 23, inputs.monthlyRate);
            const year3_2 = getCumulativeResults(results.CF2_Margin_Only, 35, inputs.monthlyRate);
            const year4_2 = getCumulativeResults(results.CF2_Margin_Only, 47, inputs.monthlyRate);


            // --- OFFRE 1 (AS) ---
            document.getElementById('totalSales1').textContent = formatNumber(results.totalSales1, 0);
            document.getElementById('effectiveClients1').textContent = formatNumber(results.effectiveClients1, 0);
            document.getElementById('totalMargin1').textContent = formatCurrency(results.totalMargin1);
            document.getElementById('upfrontMargin1').textContent = formatCurrency(results.upfrontMargin1);
            document.getElementById('tailMargin1').textContent = formatCurrency(results.tailMargin1);
            document.getElementById('totalProfitSharing').textContent = formatCurrency(results.totalProfitSharing);
            document.getElementById('totalWefixRevenue').textContent = formatCurrency(results.totalWefixRevenue); 
            document.getElementById('totalNetGain1').textContent = formatCurrency(results.totalNetGain1);
            document.getElementById('initialCashIn1').textContent = formatCurrency(results.CF1_Total_Combined[0]); 
            document.getElementById('totalNPV1').textContent = formatCurrency(results.totalNPV1);

            document.getElementById('cumulGain1_1').textContent = formatCurrency(year1_1.netGain);
            document.getElementById('cumulGain1_2').textContent = formatCurrency(year2_1.netGain);
            document.getElementById('cumulGain1_3').textContent = formatCurrency(year3_1.netGain);
            document.getElementById('cumulGain1_4').textContent = formatCurrency(year4_1.netGain);


            // --- OFFRE 2 (AP) ---
            document.getElementById('totalSales2').textContent = formatNumber(results.totalSales2, 0);
            document.getElementById('effectiveClients2').textContent = formatNumber(results.effectiveClients2, 0);
            document.getElementById('totalMargin2').textContent = formatCurrency(results.totalMargin2);
            document.getElementById('totalNetGain2').textContent = formatCurrency(results.totalNetGain2);
            document.getElementById('initialCashIn2').textContent = formatCurrency(results.CF2_Margin_Only[0]);
            document.getElementById('totalNPV2').textContent = formatCurrency(results.totalNPV2);
            
            document.getElementById('cumulGain2_1').textContent = formatCurrency(year1_2.netGain);
            document.getElementById('cumulGain2_2').textContent = formatCurrency(year2_2.netGain);
            document.getElementById('cumulGain2_3').textContent = formatCurrency(year3_2.netGain);
            document.getElementById('cumulGain2_4').textContent = formatCurrency(year4_2.netGain);
            
            // Mise à jour des 3 tables de détail
            updateAllDetailTables(results, inputs);

            // Mise à jour dynamique du texte de description du parc client
            const parkDescriptionP = document.getElementById('parkDescription');
            if (parkDescriptionP) {
                parkDescriptionP.textContent = `
                    Simulation du nombre total de clients actifs chaque mois, en tenant compte des nouvelles ventes,
                    de la renonciation (M3), du churn mensuel exponentiel (M13) et de la fin de vie. 
                    L'horizon d'attrition simulé est de ${inputs.avgContractLife1} mois (Offre 1) et ${inputs.avgContractLife2} mois (Offre 2).
                `;
            }

            // --- SYNTHÈSE VAN ---
            const vanWinnerMessage = document.getElementById('vanWinnerMessage');
            vanWinnerMessage.classList.remove('text-green-300', 'text-red-300', 'text-yellow-300');
            
            if (results.totalNPV1 > results.totalNPV2) {
                const diff = results.totalNPV1 - results.totalNPV2;
                vanWinnerMessage.textContent = `L'Offre 1 (AS) gagne ${formatCurrency(diff)} en VAN.`;
                vanWinnerMessage.classList.add('text-green-300');
            } else if (results.totalNPV2 > results.totalNPV1) {
                const diff = results.totalNPV2 - results.totalNPV1;
                vanWinnerMessage.textContent = `L'Offre 2 (AP) gagne ${formatCurrency(diff)} en VAN.`;
                vanWinnerMessage.classList.add('text-red-300');
            } else if (results.totalNPV1 > 0) {
                vanWinnerMessage.textContent = "Les deux offres ont une VAN équivalente.";
                vanWinnerMessage.classList.add('text-yellow-300');
            } else {
                 vanWinnerMessage.textContent = "Veuillez effectuer le calcul.";
                 vanWinnerMessage.classList.add('text-yellow-300');
            }
        }


        /**
         * Fonction pour insérer la configuration produit dans le tableau HTML
         */
        function setupProductConfig() {
            const container = document.getElementById('productConfig');
            container.innerHTML = products.map((p, index) => `
                <tr class="hover:bg-gray-100">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 sticky-col border-r border-gray-300">
                        ${p.name}
                        ${index === 0 ? '<span title="Le revenu Wefix est uniquement calculé sur les ventes d\'iPhones pour l\'Offre 1." class="text-xs font-bold text-red-500 ml-1">(Wefix Appliqué)</span>' : ''}
                    </td>
                    <td class="p-2">
                        <input type="number" id="volume_${index}" value="${p.volume}" min="1" class="product-input w-full text-center p-1 border rounded" oninput="calculate()">
                    </td>
                    <td class="p-2 bg-blue-50 border-l border-r border-blue-200">
                        <input type="number" id="price1_${index}" value="${p.price1}" min="0.01" step="0.01" class="product-input w-full text-center p-1 border rounded" oninput="calculate()">
                    </td>
                    <td class="p-2 bg-blue-50 border-r border-blue-200">
                        <input type="number" id="margin1_${index}" value="${p.margin1}" min="0" max="100" class="product-input w-full text-center p-1 border rounded" oninput="calculate()">
                    </td>
                    <td class="p-2 bg-blue-50 border-r border-gray-200">
                        <input type="number" id="ta1_${index}" value="${p.ta1}" min="0" max="100" class="product-input w-full text-center p-1 border rounded" oninput="calculate()">
                    </td>
                    <td class="p-2 bg-green-50 border-l border-r border-green-200">
                        <input type="number" id="price2_${index}" value="${p.price2}" min="0.01" step="0.01" class="product-input w-full text-center p-1 border rounded" oninput="calculate()">
                    </td>
                    <td class="p-2 bg-green-50 border-r border-green-200">
                        <input type="number" id="margin2_${index}" value="${p.margin2}" min="0" max="100" class="product-input w-full text-center p-1 border rounded" oninput="calculate()">
                    </td>
                    <td class="p-2 bg-green-50">
                        <input type="number" id="ta2_${index}" value="${p.ta2}" min="0" max="100" class="product-input w-full text-center p-1 border rounded" oninput="calculate()">
                    </td>
                </tr>
            `).join('');
        }

        /**
         * Fonction principale orchestrant le flux de calcul.
         */
        function calculate() {
            try {
                const inputs = getInputs();
                const results = performCalculations(inputs);
                updateUI(results, inputs);
            } catch (error) {
                console.error("Erreur lors du calcul :", error);
            }
        }


        // Initialisation à l'ouverture de la page
        window.onload = function() {
            setupProductConfig();
            calculate(); // Exécute le calcul initial avec les valeurs par défaut
        };
    </script>
</body>
</html>